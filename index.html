<!DOCTYPE html>
<html lang="lt">

<head>
    <meta charset="UTF-8">
    <title>Šeimos Kelionių Planai</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
        @media (max-width: 768px) {
            .glass-nav {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
                position: static;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5em;
            }

            .button-group {
                width: 100%;
            }

            button {
                flex-grow: 1;
                justify-content: center;
                padding: 15px;
            }

            .plan-controls {
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Tablet optimizacija */
        @media (min-width: 769px) and (max-width: 1024px) {
            .protected-areas-section {
                margin: 30px 0;
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .progress-container {
            margin: 30px 0;
            background: #f0f8ff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #2c5f96;
            font-weight: 600;
        }

        .progress-bar {
            height: 25px;
            background: #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #2c5f96 0%, #228B22 100%);
            width: 0%;
            border-radius: 12px;
            transition: width 0.5s ease, box-shadow 0.3s ease;
            box-shadow: 2px 0 8px rgba(44, 95, 150, 0.2);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    rgba(255, 255, 255, 0) 100%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .protected-areas-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            margin: 20px 0;
            padding: 15px;
            text-align: center;
        }

        .protected-areas-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .map-image-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #2c5f96;
            background: #f8fafc;
            padding: 10px;
        }

        .protected-area-map {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            transition: transform 0.3s ease;
        }

        .map-image-container:hover .protected-area-map {
            transform: scale(1.02);
        }

        .map-caption {
            text-align: center;
            margin-top: 15px;
            font-style: italic;
            color: #4a5568;
            font-size: 0.95em;
        }

        .stamp-collection-info {
            background: #f0fff4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #228B22;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                    rgba(44, 95, 150, 0.05) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(44, 95, 150, 0.05) 50%,
                    rgba(44, 95, 150, 0.05) 75%,
                    transparent 75%,
                    transparent);
            background-size: 60px 60px;
            z-index: -1;
            opacity: 0.3;
            animation: moveBg 20s linear infinite;
        }

        @keyframes moveBg {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(60px, 60px);
            }
        }

        h1 {
            background: linear-gradient(135deg, #2c5f96 0%, #228B22 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: black;
            line-height: 1.2;
        }

        input,
        textarea {
            transition: all 0.3s ease;
            border: 2px solid #cbd5e0;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
        }

        input:focus,
        textarea:focus {
            border-color: #2c5f96;
            box-shadow: 0 0 0 3px rgba(44, 95, 150, 0.1);
            outline: none;
        }

        .category-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 3px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 500;
        }

        .custom-marker {
            position: relative;
            filter: drop-shadow(0 0 6px rgba(79, 209, 197, 0.3));
        }

        .custom-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #4fd1c5;
            border-radius: 50%;
            animation: pulse 2s infinite;
            opacity: 0;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .leaflet-popup {
            z-index: 10000 !important;
            pointer-events: auto !important;
        }

        .leaflet-marker-icon {
            z-index: 1000 !important;
            position: relative;
        }

        .leaflet-popup-content {
            font-size: 16px;
            padding: 8px;
            min-width: 200px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }

        /* Klaidų pranešimų stilius */
        #map-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: max-content;
            max-width: 80%;
            background: #ff4444;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
        }

        .hidden {
            display: none;
        }

        #map-notification.show {
            display: block;
            opacity: 1;
        }

        #map-notification.fade-out {
            opacity: 0;
        }

        #plan-selector option:checked {
            background: #2c5f96 linear-gradient(0deg, #2c5f96 0%, #2c5f96 100%);
            color: white;
        }

        #map-container {
            height: 400px;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
        }

        #map {
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f8ff;
            line-height: 1.6;
            color: #2d3748;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #2c5f96;
            border-radius: 4px;
        }

        .plan-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 79, 149, 0.1);
            border: 1px solid rgba(44, 95, 150, 0.1);
        }

        #map-stats {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            z-index: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            margin: 5px 0;
            font-size: 14px;
            color: #2c5f96;
        }

        #total-distance {
            font-weight: bold;
        }

        #total-duration {
            font-weight: bold;
        }

        #plan-selector {
            padding: 12px 20px;
            border: 2px solid rgba(44, 95, 150, 0.2);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            order: 1;
            /* Perkeliame į apačią */
            width: 100%;
            margin-top: 15px;
        }

        #plan-selector:focus {
            border-color: #2c5f96;
            box-shadow: 0 0 0 3px rgba(44, 95, 150, 0.1);
        }

        .itinerary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .itinerary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 1;
        }

        .itinerary-card::after {
            content: "";
            position: absolute;
            bottom: -8px;
            left: 5%;
            width: 90%;
            height: 15px;
            background: radial-gradient(ellipse at center,
                    rgba(0, 0, 0, 0.1) 0%,
                    rgba(0, 0, 0, 0) 80%);
            filter: blur(3px);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .delete-entry-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #fff;
            color: #e53e3e;
            padding: 6px 8px;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .delete-entry-btn:hover {
            background: #fed7d7;
            transform: scale(1.1);
        }

        .time {
            color: #4a7fb8;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .place {
            color: #1a365d;
            font-size: 1.4em;
            font-weight: 700;
            margin: 8px 0 12px;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity {
            color: #2a662a;
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .notes {
            color: #4a5568;
            font-size: 0.95em;
            line-height: 1.5;
            padding: 12px;
            background: #f8fafc;
            border-left: 3px solid #cbd5e0;
            border-radius: 4px;
            margin-top: 15px;
            position: relative;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        input:focus {
            border-color: #4fd1c5;
            box-shadow: 0 0 0 3px rgba(79, 209, 197, 0.2);
        }

        .loading-text::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }

        #main-map-iframe {
            height: 500px;
            border-radius: 10px;
            width: 800px
        }

        button,
        .download-map-btn {
            background: linear-gradient(135deg, #2c5f96 0%, #228B22 100%) !important;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(44, 95, 150, 0.2);
            position: relative;
            overflow: hidden;
            align-content: center;
        }

        button:hover,
        .download-map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 95, 150, 0.3);
            opacity: 0.9;
        }

        button:active,
        .download-map-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(44, 95, 150, 0.2);
        }

        /* Mygtukų grupės išdėstymas */
        .button-group {
            justify-content: center;
            flex-wrap: wrap;
            order: 2;
            /* Mygtukai viršuje */
            display: flex;
            gap: 10px;
            /* Mygtukus dešinėje */
            margin: 10px
        }

        /* Hover efektai */
        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 25%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0) 75%);
            transform: skewX(-30deg);
            transition: left 0.6s ease;
        }

        button:hover::after {
            left: 100%;
        }

        #suggestion-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            /* Centruojam elementus horizontaliai */
        }

        #suggestion-form button[type="submit"] {
            width: auto;
            padding: 12px 40px;
        }
    </style>
</head>

<body>
    <h1 style="text-align: center;">🚗 Šeimos Kelionių Planai 🚗</h1>

    <div class="plan-controls">
        <select id="plan-selector" onchange="loadSelectedPlan()"></select>
        <div class="button-group">
            <button onclick="createNewPlan()">➕ Naujas planas</button>
            <button onclick="deleteCurrentPlan()">🗑️ Ištrinti</button>
            <button onclick="exportToGoogleMaps()">🗺️ Eksportuoti</button>
        </div>
    </div>

    <section class="protected-areas-section">
        <h2 style="text-align: center; color: #2c5f96; margin-bottom: 25px;">
            🌿 Saugomų teritorijų paso žemėlapis 🌿
        </h2>

        <div class="map-image-container">
            <img src="https://i.ibb.co/B2fP7nMs/image-2.png" alt="Saugomų teritorijų žemėlapis"
                class="protected-area-map">
        </div>

        <div class="progress-container">
            <div class="progress-header">
                <span>🟢 Aplankyta parkų</span>
                <span id="progress-count">0 / 35</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <a href="https://i.ibb.co/B2fP7nMs/image-2.png" download="https://i.ibb.co/B2fP7nMs/image-2.png"
            class="download-map-btn">
            📥 Parsisiųsti žemėlapį
        </a>
        </div>
    </section>

    <div id="map-stats" class="hidden">
        <div class="stat-item">🛣️ Bendras atstumas: <span id="total-distance">-</span></div>
        <div class="stat-item">⏱️ Laikas automobilyje: <span id="total-duration">-</span></div>
    </div>

    <hr color: #2c5f96>

    <h1 style="text-align: center; color: #2c5f96; margin: 25px 0 15px;">
        Idėjos
    </h1>

    <div id="itinerary-container"></div>

    <div id="map-container" class="hidden">
        <div id="map"></div>
        <div id="map-notification"></div> <!-- Klaidų pranešimai -->
    </div>

    <hr>

    <h1 style="text-align: center; color: #2c5f96; margin: 25px 0 15px;">✏️ Pridėti naują veiklą ✏️</h1>
    <form id="suggestion-form">
        <input type="text" placeholder="Laikas (pvz.: 9:00-10:00)">
        <input type="text" placeholder="Vieta (pvz.: V. Mačernio g. XX, Plungė)" required>
        <input type="text" placeholder="Veikla (pvz.: Pažintinis takas)">
        <textarea placeholder="Pastabos (pvz.: Lankymas nemokamas / Jūsų slapyvardis)" rows="3" required></textarea>
        <button type="submit">Pateikti</button>
    </form>

    <hr color: #2c5f96>

    <h1 style="text-align: center; color: #2c5f96; margin: 25px 0 15px;">
        Lankytinų vietų žemėlapis
    </h1>

    <iframe id="main-map-iframe" src="https://www.google.com/maps/d/embed?mid=1fsbbjLhR0yt88yeY4OPh3ODFNtA&ehbc=2E312F">
    </iframe>

    <script>
        // Rodyti/uždaryti loading indikatorių
        function toggleLoader(show) {
            const loader = document.createElement('div');
            loader.className = `loading-overlay ${show ? 'visible' : 'hidden'}`;
            loader.innerHTML = `<div class="spinner">🔄 Kraunama...</div>`;
            if (show) {
                document.body.appendChild(loader);
            } else {
                document.querySelector('.loading-overlay')?.remove();
            }
        }

        // Automatinis scroll į formą po submit
        document.getElementById('suggestion-form').addEventListener('submit', () => {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        });

        // Blokuojame klaviatūros trumpinius
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                alert('Ši operacija draudžiama!');
            }
        });

        // Blokuojame dešinį pelės mygtuką
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        // Blokuojame iframe įkėlimą
        if (window.top !== window.self) window.top.location = window.self.location;

        async function exportToGoogleMaps() {
            if (!currentPlanId || !map) {
                alert("Pirma pasirinkite planą su maršrutu");
                return;
            }

            const doc = await db.collection("plans").doc(currentPlanId).get();
            const entries = doc.data().entries;

            if (entries.length < 2) {
                alert("Maršrutui reikia bent dviejų vietų!");
                return;
            }

            // Gauti koordinates visiems taškams
            const coordinates = [];
            for (const entry of entries) {
                try {
                    const coords = await geocodePlace(entry.place);
                    if (coords) coordinates.push(coords);
                } catch (error) {
                    console.error("Klaida geokoduojant:", entry.place, error);
                }
            }

            if (coordinates.length < 2) {
                alert("Nepavyko gauti pakankamai koordinačių");
                return;
            }

            // Mobile aptikimas
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // URL kūrimas
            const origin = `${coordinates[0][0]},${coordinates[0][1]}`;
            const destination = `${coordinates[coordinates.length - 1][0]},${coordinates[coordinates.length - 1][1]}`;

            let url;
            if (isMobile) {
                // Supaprastinta versija mobiliesiems
                url = new URL("https://www.google.com/maps/dir/");
                url.searchParams.set('api', '1');
                url.searchParams.set('origin', origin);
                url.searchParams.set('destination', destination);
                url.searchParams.set('travelmode', 'driving');
                url.searchParams.set('_fsi', '1'); // Force web version
            } else {
                // Pilna versija desktop
                const waypoints = coordinates.slice(1, -1).map(c => `${c[0]},${c[1]}`).join('|');
                url = new URL("https://www.google.com/maps/dir/");
                url.searchParams.set('api', '1');
                url.searchParams.set('origin', origin);
                url.searchParams.set('destination', destination);
                if (waypoints) url.searchParams.set('waypoints', waypoints);
            }

            // Atidarymo logika
            if (isMobile) {
                window.location.href = url.toString(); // Geriau veikia mobiliuose
            } else {
                window.open(url.toString(), '_blank');
            }
        }

        // ========== FIREBASE KONFIGURACIJA ==========
        const firebaseConfig = {
            apiKey: "AIzaSyA9tCzFLCJPB4vtEEZ0TTBUlcOCRdECJwc",
            authDomain: "family-trips-f5c7a.firebaseapp.com",
            projectId: "family-trips-f5c7a",
            storageBucket: "family-trips-f5c7a.firebasestorage.app",
            messagingSenderId: "849102410337",
            appId: "1:849102410337:web:a6f20ae607dca469121020"
        };

        // INICIALIZUOTI FIREBASE
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== KINTAMIEJI ==========
        let currentPlanId = null;
        let map = null;
        let markers = [];
        let activeGeocoding = false; // Pridėtas flag'as

        // ========== ŽEMĖLAPIO FUNKCIJOS ==========
        let routeControl = null;

        function initMap() {
            if (map) map.remove();
            map = L.map('map').setView([55.1694, 23.8813], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        async function updateMap(places) {
            // Valymo operacijos
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (routeControl) map.removeControl(routeControl);

            const unresolvedPlaces = [];
            const coordinates = [];
            const uniquePlaces = [...new Set(places)];


            for (const place of uniquePlaces) {
                try {
                    const coords = await geocodePlace(place);
                    if (coords) {
                        const latLng = L.latLng(coords[0], coords[1]);
                        if (!coordinates.some(c => c.equals(latLng))) {
                            coordinates.push(latLng);

                            // Sukuriamas žymeklis su popup
                            const marker = L.marker(latLng)
                                .bindPopup(place)
                                .on('click', function () {
                                    this.openPopup(); // Privaloma papildoma aktyvacija
                                });

                            marker.addTo(map);
                            markers.push(marker);
                        }
                    }
                } catch (error) {
                    unresolvedPlaces.push(place);
                }
            }

            if (coordinates.length >= 2) {
                try {
                    if (routeControl) map.removeControl(routeControl);

                    routeControl = L.Routing.control({
                        waypoints: coordinates,
                        router: new L.Routing.OSRMv1({
                            serviceUrl: "https://router.project-osrm.org/route/v1",
                            timeout: 15000
                        }),
                        lineOptions: {
                            styles: [{ color: '#2c5f96', weight: 5 }]
                        },
                        show: false,
                        addWaypoints: false,
                        createMarker: () => null // Išjungti automatinius žymeklius
                    }).addTo(map);

                    routeControl.on('routesfound', (e) => {
                        const route = e.routes[0];
                        const bounds = new L.LatLngBounds();
                        e.routes[0].coordinates.forEach(coord => bounds.extend(coord));
                        map.fitBounds(bounds.pad(0.2));
                        const totalDistance = (route.summary.totalDistance / 1000).toFixed(1);
                        const totalDuration = Math.round(route.summary.totalTime / 60);
                        document.getElementById('map-stats').classList.remove('hidden');
                        document.getElementById('total-distance').textContent = `${totalDistance} km`;
                        document.getElementById('total-duration').textContent = `${totalDuration} min`;
                    });

                    routeControl.on('routingerror', function () {
                        document.getElementById('map-stats').classList.add('hidden');
                    });

                } catch (error) {
                    console.log('Klaida:', error);
                    showMapNotification("🚧 Maršruto sudarymas nepavyko");
                }
            }
        }

        // Pagalbinės funkcijos
        function isValidCoordinate(lat, lng) {
            return (
                typeof lat === 'number' &&
                typeof lng === 'number' &&
                lat >= -90 && lat <= 90 &&
                lng >= -180 && lng <= 180
            );
        }

        async function geocodePlace(placeName) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(placeName)}&limit=1`,
                    {
                        headers: {
                            "User-Agent": "FamilyTripsApp/3.0 (contact@example.com)",
                            "Accept-Language": "lt"
                        }
                    }
                );
                const data = await response.json();
                if (!data[0]) return null;

                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                return [lat, lon];
            } catch (error) {
                console.error('Geokoderio klaida:', error);
                return null;
            }
        }

        // Atnaujinta showMapNotification funkcija
        function showMapNotification(message) {
            const notification = document.getElementById("map-notification");
            notification.textContent = message;

            if (message) {
                notification.classList.remove("fade-out");
                notification.classList.add("show");
                setTimeout(() => {
                    notification.classList.add("fade-out");
                    setTimeout(() => notification.classList.remove("show"), 500);
                }, 5000);
            } else {
                notification.classList.remove("show");
            }
        }

        function hideMapNotification() {
            const notification = document.getElementById("map-notification");
            notification.classList.add("fade-out");
            setTimeout(() => {
                notification.classList.remove("show");
            }, 500);
        }

        // Geokodavimas su klaidų valdymu
        async function geocodePlace(placeName) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(placeName)}`,
                    {
                        headers: {
                            "User-Agent": "FamilyTripsApp/1.0 (contact@example.com)"
                        }
                    }
                );
                const data = await response.json();
                return data[0] ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
            } catch (error) {
                console.error("Klaida:", error);
                return null;
            }
        }

        // ========== FUNKCIJOS ==========
        function parseTime(timeString) {
            const [startTime] = timeString.split(/[-–]/).map(t => t.trim());
            const [hours, minutes] = startTime.split(/[:\.]/).map(Number);
            return hours * 60 + (minutes || 0);
        }

        function initPlans() {
            db.collection("plans").onSnapshot(snapshot => {
                const plans = [];
                snapshot.forEach(doc => plans.push({ id: doc.id, ...doc.data() }));
                refreshPlanSelector(plans);
                if (plans.length > 0 && !currentPlanId) currentPlanId = plans[0].id;
                renderItinerary();
            });
        }

        function refreshPlanSelector(plans) {
            const selector = document.getElementById('plan-selector');
            selector.innerHTML = plans.map(plan => `
        <option value="${plan.id}" ${plan.id === currentPlanId ? 'selected' : ''}>${plan.name}</option>
    `).join('');
        }

        async function createNewPlan() {
            const planName = prompt('Pavadinimas:');
            if (!planName) return;

            const planType = ("Ar tai maršrutas? (OK - su maršrutu, Cancel - pavienės vietos)")
                ? 'route'
                : 'points';

            try {
                const docRef = await db.collection("plans").add({
                    name: planName,
                    type: planType, // <-- Naujas laukas
                    entries: [],
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentPlanId = docRef.id;
            } catch (error) {
                console.error("Klaida kuriant planą:", error);
                alert("Nepavyko sukurti plano!");
            }
        }

        async function deleteCurrentPlan() {
            if (!currentPlanId || !confirm('Ar tikrai norite ištrinti planą?')) return;

            try {
                await db.collection("plans").doc(currentPlanId).delete();

                // Gauti atnaujintus planus
                const snapshot = await db.collection("plans").get();
                const plans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (plans.length > 0) {
                    currentPlanId = plans[0].id;
                } else {
                    currentPlanId = null;
                    document.getElementById("map-container").classList.add("hidden");
                    document.getElementById("itinerary-container").innerHTML = ""; // Išvalyti sąrašą
                }

                renderItinerary();
            } catch (error) {
                console.error("Trinant klaida:", error);
                alert("Nepavyko ištrinti plano!");
            }
        }

        function loadSelectedPlan() {
            currentPlanId = document.getElementById('plan-selector').value;
            renderItinerary();
        }

        async function deleteEntry(entryId) {
            const planRef = db.collection("plans").doc(currentPlanId);
            const doc = await planRef.get();

            const updatedEntries = doc.data().entries.filter(entry =>
                entry.id !== entryId
            );

            await planRef.update({ entries: updatedEntries });
        }

        async function renderItinerary() {
            const container = document.getElementById('itinerary-container');

            if (!currentPlanId) return;

            const doc = await db.collection("plans").doc(currentPlanId).get();
            if (!doc.exists) return;

            const entries = [...doc.data().entries].sort((a, b) =>
                parseTime(a.time) - parseTime(b.time)
            );

            const places = doc.data().entries.map(entry => entry.place);
            document.getElementById("map-container").classList.remove("hidden");
            if (!map) initMap();
            updateMap(places);

            container.innerHTML = entries.map((entry, index) => `
        <div class="itinerary-card">
            <button class="delete-entry-btn" onclick="deleteEntry('${entry.id}')">🗑️</button>
            <div class="place">📍${entry.place}</div>
            <div class="time">⏰ ${entry.time}</div>
            <div class="activity">📌 ${entry.activity}</div>
            <div class="notes">ℹ️ ${entry.notes}</div>
        </div>
    `).join('');
        }

        document.getElementById('suggestion-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formElements = e.target.elements;

            const newEntry = {
                id: Date.now().toString(), // Unikalus ID
                time: formElements[0].value,
                place: formElements[1].value,
                activity: formElements[2].value,
                notes: formElements[3].value
            };

            await db.collection("plans").doc(currentPlanId).update({
                entries: firebase.firestore.FieldValue.arrayUnion(newEntry)
            });

            e.target.reset();
        });

        function updateProgress(visitedCount) {
            const progressFill = document.getElementById('progress-fill');
            const progressCount = document.getElementById('progress-count');
            const percentage = (visitedCount / 35) * 100;

            progressFill.style.width = `${percentage}%`;
            progressCount.textContent = `${visitedCount} / 35`;

            // Gradiento animacija
            const hueRotate = percentage * 3.6;
            progressFill.style.background = `linear-gradient(
        135deg, 
        hsl(${200 - (percentage * 0.5)}, 60%, 45%) 0%, 
        hsl(${120 + (percentage * 0.3)}, 80%, 35%) 100%
    )`;
        }

        updateProgress(11); // Pakeiskite skaičių į tikrą aplankytų parkų kiekį

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                const startPosition = window.pageYOffset;
                const targetPosition = target.offsetTop;
                const distance = targetPosition - startPosition;
                const duration = 1000;
                let start = null;

                window.requestAnimationFrame(function step(timestamp) {
                    if (!start) start = timestamp;
                    const progress = timestamp - start;
                    window.scrollTo(0, easeInOutQuad(progress, startPosition, distance, duration));
                    if (progress < duration) window.requestAnimationFrame(step);
                });
            });
        });

        function easeInOutQuad(t, b, c, d) {
            t /= d / 2;
            if (t < 1) return c / 2 * t * t + b;
            t--;
            return -c / 2 * (t * (t - 2) - 1) + b;
        }

        // Paleisti
        initPlans();
    </script>
</body>

</html>
